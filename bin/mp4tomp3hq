#!/bin/bash

# å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common.sh"

# ä½¿ç”¨æ–¹æ³•
usage() {
    echo -e "${CYAN}ä½¿ç”¨æ–¹æ³•:${NC}"
    echo "  mp4tomp3hq file1.mp4 [file2.mp4 ...]"
    echo
    echo -e "${CYAN}èª¬æ˜:${NC}"
    echo "  MP4ãƒ•ã‚¡ã‚¤ãƒ«ã‚’MP3ï¼ˆ320kbps é«˜éŸ³è³ªï¼‰ã«å¤‰æ›ã—ã¾ã™"
    echo
    echo -e "${CYAN}ä¾‹:${NC}"
    echo "  mp4tomp3hq video.mp4"
    echo "  mp4tomp3hq *.mp4"
}

# ãƒ˜ãƒ«ãƒ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å‡¦ç†
if [[ "$1" == "-h" || "$1" == "--help" || $# -eq 0 ]]; then
    usage
    exit 0
fi

# ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
if ! check_dependency "ffmpeg" "ffmpeg"; then
    echo -e "${YELLOW}macOS: brew install ffmpeg${NC}"
    echo -e "${YELLOW}Ubuntu: sudo apt install ffmpeg${NC}"
    exit 1
fi

# MP4â†’MP3(é«˜éŸ³è³ª)å¤‰æ›é–¢æ•°
mp4tomp3hq() {
    local files=("$@")
    local total=${#files[@]}
    local current=0
    local start_time=$(date +%s)
    
    echo -e "${PURPLE}ğŸµ MP4â†’MP3å¤‰æ›(é«˜éŸ³è³ª)ã‚’é–‹å§‹ã—ã¾ã™ (${total}ãƒ•ã‚¡ã‚¤ãƒ«)${NC}\n"
    
    for file in "${files[@]}"; do
        if check_file_extension "$file" "mp4"; then
            ((current++))
            output="${file%.*}.mp3"
            input_size=$(get_file_size "$file")
            
            echo -e "${YELLOW}ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ« ${current}/${total}:${NC} $(basename "$file")"
            echo -e "${BLUE}   å…¥åŠ›ã‚µã‚¤ã‚º:${NC} $(format_size $input_size)"
            echo -e "${BLUE}   å‡ºåŠ›å…ˆ:${NC} $(basename "$output") ${CYAN}(320kbps é«˜éŸ³è³ª)${NC}"
            
            local file_start=$(date +%s)
            if ffmpeg -i "$file" -vn -acodec mp3 -ab 320k "$output" -loglevel error -hide_banner; then
                local file_end=$(date +%s)
                local file_duration=$((file_end - file_start))
                local output_size=$(get_file_size "$output")
                
                echo -e "${GREEN}   âœ… å®Œäº†${NC} ($(format_duration $file_duration)) - å‡ºåŠ›: $(format_size $output_size)"
                show_progress $current $total
                echo
            else
                echo -e "${RED}   âŒ ã‚¨ãƒ©ãƒ¼: å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
            fi
        fi
        echo
    done
    
    local end_time=$(date +%s)
    local total_duration=$((end_time - start_time))
    echo -e "\n${GREEN}ğŸ‰ ã™ã¹ã¦ã®å¤‰æ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼${NC}"
    echo -e "${WHITE}ç·å‡¦ç†æ™‚é–“: $(format_duration $total_duration)${NC}"
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
mp4tomp3hq "$@" 