#!/bin/bash

# å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common.sh"

# ä½¿ç”¨æ–¹æ³•
usage() {
    echo -e "${CYAN}${BOLD}ğŸµ MP4â†’MP3å¤‰æ›ãƒ„ãƒ¼ãƒ« (v1.1.0)${NC}"
    echo
    echo -e "${CYAN}ä½¿ç”¨æ–¹æ³•:${NC}"
    echo "  mp4tomp3 [ã‚ªãƒ—ã‚·ãƒ§ãƒ³] file1.mp4 [file2.mp4 ...]"
    echo
    echo -e "${CYAN}ã‚ªãƒ—ã‚·ãƒ§ãƒ³:${NC}"
    echo "  -h, --help       ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º"
    echo "  -q, --quality    éŸ³è³ªã‚’æŒ‡å®š (128k, 192k, 256k, 320k)"
    echo "  -j, --jobs       ä¸¦åˆ—å‡¦ç†æ•°ã‚’æŒ‡å®š"
    echo "  -o, --output     å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®š"
    echo "  -v, --verify     å¤‰æ›å¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼"
    echo "  --config         è¨­å®šã‚’è¡¨ç¤º"
    echo "  --stats          çµ±è¨ˆã‚’è¡¨ç¤º"
    echo "  --no-notify      é€šçŸ¥ã‚’ç„¡åŠ¹åŒ–"
    echo
    echo -e "${CYAN}èª¬æ˜:${NC}"
    echo "  MP4ãƒ•ã‚¡ã‚¤ãƒ«ã‚’MP3ã«å¤‰æ›ã—ã¾ã™"
    echo "  è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«: ${WHITE}$CONFIG_FILE${NC}"
    echo
    echo -e "${CYAN}ä¾‹:${NC}"
    echo "  mp4tomp3 video.mp4"
    echo "  mp4tomp3 -q 320k *.mp4"
    echo "  mp4tomp3 -j 8 -o ~/Music *.mp4"
}

# ã‚ªãƒ—ã‚·ãƒ§ãƒ³è§£æ
QUALITY=""
JOBS=""
OUTPUT_DIR=""
VERIFY_FILES=false
SHOW_CONFIG=false
SHOW_STATS=false
DISABLE_NOTIFY=false
FILES=()

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            exit 0
            ;;
        -q|--quality)
            QUALITY="$2"
            shift 2
            ;;
        -j|--jobs)
            JOBS="$2"
            shift 2
            ;;
        -o|--output)
            OUTPUT_DIR="$2"
            shift 2
            ;;
        -v|--verify)
            VERIFY_FILES=true
            shift
            ;;
        --config)
            SHOW_CONFIG=true
            shift
            ;;
        --stats)
            SHOW_STATS=true
            shift
            ;;
        --no-notify)
            DISABLE_NOTIFY=true
            shift
            ;;
        -*)
            echo -e "${RED}âŒ ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1${NC}"
            usage
            exit 1
            ;;
        *)
            FILES+=("$1")
            shift
            ;;
    esac
done

# è¨­å®šãƒ»çµ±è¨ˆè¡¨ç¤º
if [[ "$SHOW_CONFIG" == "true" ]]; then
    show_config
    exit 0
fi

if [[ "$SHOW_STATS" == "true" ]]; then
    show_stats
    exit 0
fi

# ãƒ•ã‚¡ã‚¤ãƒ«å¼•æ•°ãƒã‚§ãƒƒã‚¯
if [[ ${#FILES[@]} -eq 0 ]]; then
    usage
    exit 0
fi

# é€šçŸ¥è¨­å®š
if [[ "$DISABLE_NOTIFY" == "true" ]]; then
    ENABLE_NOTIFICATIONS=false
fi

# å“è³ªè¨­å®š
if [[ -n "$QUALITY" ]]; then
    MP3_QUALITY="$QUALITY"
fi

# ä¸¦åˆ—å‡¦ç†æ•°è¨­å®š
if [[ -n "$JOBS" ]]; then
    PARALLEL_JOBS="$JOBS"
fi

# ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
if ! check_dependency "ffmpeg" "ffmpeg"; then
    echo -e "${YELLOW}macOS: brew install ffmpeg${NC}"
    echo -e "${YELLOW}Ubuntu: sudo apt install ffmpeg${NC}"
    exit 1
fi

# å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
if [[ -n "$OUTPUT_DIR" ]] && [[ ! -d "$OUTPUT_DIR" ]]; then
    mkdir -p "$OUTPUT_DIR"
    log_info "å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ: $OUTPUT_DIR"
fi

# MP4â†’MP3å¤‰æ›é–¢æ•°
convert_mp4_to_mp3() {
    local file=$1
    local file_start=$(date +%s)
    
    if ! check_file_extension "$file" "mp4"; then
        return 1
    fi
    
    # ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
    if ! verify_file "$file" "video"; then
        echo -e "${RED}   âŒ ç„¡åŠ¹ãªMP4ãƒ•ã‚¡ã‚¤ãƒ«: $file${NC}"
        log_error "ç„¡åŠ¹ãªMP4ãƒ•ã‚¡ã‚¤ãƒ«: $file"
        return 1
    fi
    
    # å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«åæ±ºå®š
    local basename=$(basename "$file" .mp4)
    local output
    if [[ -n "$OUTPUT_DIR" ]]; then
        output="$OUTPUT_DIR/$basename.mp3"
    else
        output="${file%.*}.mp3"
    fi
    
    # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯
    if [[ -f "$output" ]]; then
        echo -e "${YELLOW}   âš ï¸  ã‚¹ã‚­ãƒƒãƒ—: $output ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™${NC}"
        log_info "ã‚¹ã‚­ãƒƒãƒ—: $output (æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«)"
        return 0
    fi
    
    local input_size=$(get_file_size "$file")
    echo -e "${BLUE}   å…¥åŠ›ã‚µã‚¤ã‚º:${NC} $(format_size $input_size)"
    echo -e "${BLUE}   éŸ³è³ª:${NC} $MP3_QUALITY"
    echo -e "${BLUE}   å‡ºåŠ›å…ˆ:${NC} $(basename "$output")"
    
    # å¤‰æ›å®Ÿè¡Œ
    if ffmpeg -i "$file" -vn -acodec mp3 -ab "$MP3_QUALITY" "$output" -loglevel error -hide_banner 2>/dev/null; then
        local file_end=$(date +%s)
        local file_duration=$((file_end - file_start))
        local output_size=$(get_file_size "$output")
        
        echo -e "${GREEN}   âœ… å®Œäº†${NC} ($(format_duration $file_duration)) - å‡ºåŠ›: $(format_size $output_size)"
        log_success "MP4â†’MP3å¤‰æ›å®Œäº†: $file â†’ $output"
        
        # ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
        if [[ "$VERIFY_FILES" == "true" ]]; then
            if verify_file "$output" "audio"; then
                echo -e "${GREEN}   ğŸ” æ¤œè¨¼: OK${NC}"
            else
                echo -e "${RED}   ğŸ” æ¤œè¨¼: ã‚¨ãƒ©ãƒ¼${NC}"
                log_error "å¤‰æ›ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: $output"
            fi
        fi
        
        # å…ƒãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ï¼ˆè¨­å®šã«ã‚ˆã‚‹ï¼‰
        if [[ "$DELETE_ORIGINAL" == "true" ]]; then
            rm "$file"
            log_info "å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤: $file"
        fi
        
        return 0
    else
        echo -e "${RED}   âŒ ã‚¨ãƒ©ãƒ¼: å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
        log_error "MP4â†’MP3å¤‰æ›ã‚¨ãƒ©ãƒ¼: $file"
        return 1
    fi
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    local files=("${FILES[@]}")
    local total=${#files[@]}
    local start_time=$(date +%s)
    local successful=0
    local failed=0
    
    echo -e "${PURPLE}ğŸµ MP4â†’MP3å¤‰æ›ã‚’é–‹å§‹ã—ã¾ã™${NC}"
    echo -e "${WHITE}ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $total | ä¸¦åˆ—å‡¦ç†: $PARALLEL_JOBS | éŸ³è³ª: $MP3_QUALITY${NC}"
    echo
    
    # ä¸¦åˆ—å‡¦ç†ç”¨ã‚¸ãƒ§ãƒ–é…åˆ—ä½œæˆ
    local jobs=()
    local current=0
    
    for file in "${files[@]}"; do
        ((current++))
        jobs+=("echo -e '${YELLOW}ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ« ${current}/${total}:${NC} $(basename "$file")' && convert_mp4_to_mp3 '$file' && echo")
    done
    
    # ä¸¦åˆ—å®Ÿè¡Œ
    if [[ $PARALLEL_JOBS -gt 1 ]] && [[ $total -gt 1 ]]; then
        echo -e "${BLUE}ğŸš€ ä¸¦åˆ—å‡¦ç†ã§å¤‰æ›ã‚’å®Ÿè¡Œã—ã¾ã™...${NC}"
        run_parallel $PARALLEL_JOBS "${jobs[@]}"
    else
        # é€æ¬¡å®Ÿè¡Œ
        for job in "${jobs[@]}"; do
            eval "$job"
            ((current++))
            show_progress $current $total
        done
        echo
    fi
    
    # çµæœé›†è¨ˆ
    for file in "${files[@]}"; do
        local basename=$(basename "$file" .mp4)
        local output
        if [[ -n "$OUTPUT_DIR" ]]; then
            output="$OUTPUT_DIR/$basename.mp3"
        else
            output="${file%.*}.mp3"
        fi
        
        if [[ -f "$output" ]]; then
            ((successful++))
        else
            ((failed++))
        fi
    done
    
    local end_time=$(date +%s)
    local total_duration=$((end_time - start_time))
    
    echo -e "${GREEN}ğŸ‰ å¤‰æ›å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼${NC}"
    echo -e "${WHITE}æˆåŠŸ: $successful | å¤±æ•—: $failed | ç·å‡¦ç†æ™‚é–“: $(format_duration $total_duration)${NC}"
    
    # é€šçŸ¥é€ä¿¡
    if [[ $successful -gt 0 ]]; then
        send_notification "Media-to-Media" "$successfulå€‹ã®MP4ãƒ•ã‚¡ã‚¤ãƒ«ã‚’MP3ã«å¤‰æ›ã—ã¾ã—ãŸ" "Glass"
    fi
    
    log_info "MP4â†’MP3ä¸€æ‹¬å¤‰æ›å®Œäº†: æˆåŠŸ=$successful, å¤±æ•—=$failed, æ™‚é–“=${total_duration}s"
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main 