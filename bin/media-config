#!/bin/bash

# å…±é€šãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã¿
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common.sh"

# ä½¿ç”¨æ–¹æ³•
usage() {
    echo -e "${CYAN}${BOLD}âš™ï¸ Media-to-Media è¨­å®šç®¡ç†ãƒ„ãƒ¼ãƒ«${NC}"
    echo
    echo -e "${CYAN}ä½¿ç”¨æ–¹æ³•:${NC}"
    echo "  media-config [ã‚³ãƒãƒ³ãƒ‰] [ã‚ªãƒ—ã‚·ãƒ§ãƒ³]"
    echo
    echo -e "${CYAN}ã‚³ãƒãƒ³ãƒ‰:${NC}"
    echo "  show                 ç¾åœ¨ã®è¨­å®šã‚’è¡¨ç¤º"
    echo "  stats                å¤‰æ›çµ±è¨ˆã‚’è¡¨ç¤º"
    echo "  set <key> <value>    è¨­å®šå€¤ã‚’å¤‰æ›´"
    echo "  reset                è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆ"
    echo "  logs                 ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º"
    echo "  cleanup              å¤ã„ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"
    echo "  update               ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯"
    echo "  test                 ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒ†ã‚¹ãƒˆ"
    echo
    echo -e "${CYAN}è¨­å®šå¯èƒ½ãªé …ç›®:${NC}"
    echo -e "${WHITE}  PARALLEL_JOBS${NC}       ä¸¦åˆ—å‡¦ç†æ•° (1-16)"
    echo -e "${WHITE}  ENABLE_NOTIFICATIONS${NC} é€šçŸ¥ã®æœ‰åŠ¹/ç„¡åŠ¹ (true/false)"
    echo -e "${WHITE}  ENABLE_LOGGING${NC}      ãƒ­ã‚°ã®æœ‰åŠ¹/ç„¡åŠ¹ (true/false)"
    echo -e "${WHITE}  MP3_QUALITY${NC}         MP3éŸ³è³ª (128k, 192k, 256k, 320k)"
    echo -e "${WHITE}  AAC_QUALITY${NC}         AACéŸ³è³ª (128k, 192k, 256k, 320k)"
    echo -e "${WHITE}  PNG_DPI${NC}             PNGè§£åƒåº¦ (72, 150, 300, 600)"
    echo -e "${WHITE}  JPG_DPI${NC}             JPGè§£åƒåº¦ (72, 150, 300, 600)"
    echo -e "${WHITE}  JPG_QUALITY${NC}         JPGå“è³ª (50-100)"
    echo -e "${WHITE}  DELETE_ORIGINAL${NC}     å…ƒãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ (true/false)"
    echo
    echo -e "${CYAN}ä¾‹:${NC}"
    echo "  media-config show"
    echo "  media-config set PARALLEL_JOBS 8"
    echo "  media-config set MP3_QUALITY 320k"
    echo "  media-config stats"
}

# è¨­å®šå€¤æ›´æ–°
update_config() {
    local key=$1
    local value=$2
    
    # å€¤ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
    case $key in
        PARALLEL_JOBS)
            if ! [[ "$value" =~ ^[1-9][0-6]?$ ]] || [[ $value -gt 16 ]]; then
                echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼: ä¸¦åˆ—å‡¦ç†æ•°ã¯1-16ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„${NC}"
                return 1
            fi
            ;;
        ENABLE_NOTIFICATIONS|ENABLE_LOGGING|DELETE_ORIGINAL)
            if [[ "$value" != "true" && "$value" != "false" ]]; then
                echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼: true ã¾ãŸã¯ false ã‚’æŒ‡å®šã—ã¦ãã ã•ã„${NC}"
                return 1
            fi
            ;;
        MP3_QUALITY|AAC_QUALITY)
            if [[ ! "$value" =~ ^(128k|192k|256k|320k)$ ]]; then
                echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼: éŸ³è³ªã¯ 128k, 192k, 256k, 320k ã®ã„ãšã‚Œã‹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„${NC}"
                return 1
            fi
            ;;
        PNG_DPI|JPG_DPI)
            if [[ ! "$value" =~ ^(72|150|300|600)$ ]]; then
                echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼: è§£åƒåº¦ã¯ 72, 150, 300, 600 ã®ã„ãšã‚Œã‹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„${NC}"
                return 1
            fi
            ;;
        JPG_QUALITY)
            if ! [[ "$value" =~ ^[5-9][0-9]$|^100$ ]] || [[ $value -lt 50 ]]; then
                echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼: JPGå“è³ªã¯50-100ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„${NC}"
                return 1
            fi
            ;;
        *)
            echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªè¨­å®šé …ç›®: $key${NC}"
            echo -e "${YELLOW}åˆ©ç”¨å¯èƒ½ãªè¨­å®šé …ç›®ã¯ --help ã§ç¢ºèªã—ã¦ãã ã•ã„${NC}"
            return 1
            ;;
    esac
    
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°
    if grep -q "^$key=" "$CONFIG_FILE"; then
        # macOS ã¨ Linux ã® sed ã®é•ã„ã«å¯¾å¿œ
        if [[ "$OSTYPE" == "darwin"* ]]; then
            sed -i '' "s/^$key=.*/$key=$value/" "$CONFIG_FILE"
        else
            sed -i "s/^$key=.*/$key=$value/" "$CONFIG_FILE"
        fi
    else
        echo "$key=$value" >> "$CONFIG_FILE"
    fi
    
    echo -e "${GREEN}âœ… è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ: $key = $value${NC}"
    log_info "è¨­å®šæ›´æ–°: $key=$value"
}

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º
show_logs() {
    local lines=${1:-50}
    
    if [[ -f "$LOG_FILE" ]]; then
        echo -e "${CYAN}ğŸ“‹ æœ€æ–°ã®ãƒ­ã‚° (${lines}è¡Œ):${NC}"
        echo -e "${WHITE}ãƒ•ã‚¡ã‚¤ãƒ«: $LOG_FILE${NC}"
        echo
        tail -n "$lines" "$LOG_FILE" | while IFS= read -r line; do
            case $line in
                *ERROR*)
                    echo -e "${RED}$line${NC}"
                    ;;
                *SUCCESS*)
                    echo -e "${GREEN}$line${NC}"
                    ;;
                *INFO*)
                    echo -e "${BLUE}$line${NC}"
                    ;;
                *)
                    echo "$line"
                    ;;
            esac
        done
    else
        echo -e "${YELLOW}âš ï¸  ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}"
    fi
}

# ãƒ­ã‚°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
cleanup_logs() {
    if [[ -f "$LOG_FILE" ]]; then
        local size=$(get_file_size "$LOG_FILE")
        local formatted_size=$(format_size $size)
        
        echo -e "${BLUE}ğŸ§¹ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™...${NC}"
        echo -e "${WHITE}ç¾åœ¨ã®ã‚µã‚¤ã‚º: $formatted_size${NC}"
        
        # æœ€æ–°ã®1000è¡Œã®ã¿ä¿æŒ
        tail -n 1000 "$LOG_FILE" > "$LOG_FILE.tmp"
        mv "$LOG_FILE.tmp" "$LOG_FILE"
        
        local new_size=$(get_file_size "$LOG_FILE")
        local new_formatted_size=$(format_size $new_size)
        
        echo -e "${GREEN}âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†${NC}"
        echo -e "${WHITE}æ–°ã—ã„ã‚µã‚¤ã‚º: $new_formatted_size${NC}"
        log_info "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ"
    else
        echo -e "${YELLOW}âš ï¸  ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“${NC}"
    fi
}

# ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
run_tests() {
    echo -e "${BLUE}ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™...${NC}"
    echo
    
    local tests_passed=0
    local tests_total=0
    
    # ä¾å­˜é–¢ä¿‚ãƒ†ã‚¹ãƒˆ
    echo -e "${CYAN}ğŸ“¦ ä¾å­˜é–¢ä¿‚ãƒ†ã‚¹ãƒˆ:${NC}"
    ((tests_total++))
    if check_dependency "ffmpeg" "ffmpeg" && check_dependency "pdftoppm" "poppler-utils"; then
        echo -e "${GREEN}âœ… ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ãŒåˆ©ç”¨å¯èƒ½ã§ã™${NC}"
        ((tests_passed++))
    else
        echo -e "${RED}âŒ ä¾å­˜é–¢ä¿‚ãŒä¸è¶³ã—ã¦ã„ã¾ã™${NC}"
    fi
    
    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆ
    echo -e "${CYAN}âš™ï¸  è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ†ã‚¹ãƒˆ:${NC}"
    ((tests_total++))
    if [[ -f "$CONFIG_FILE" ]] && [[ -r "$CONFIG_FILE" ]]; then
        echo -e "${GREEN}âœ… è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™${NC}"
        ((tests_passed++))
    else
        echo -e "${RED}âŒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“${NC}"
    fi
    
    # ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ†ã‚¹ãƒˆ
    echo -e "${CYAN}ğŸ“ ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ†ã‚¹ãƒˆ:${NC}"
    ((tests_total++))
    if [[ -d "$LOG_DIR" ]] && [[ -w "$LOG_DIR" ]]; then
        echo -e "${GREEN}âœ… ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ›¸ãè¾¼ã¿å¯èƒ½ã§ã™${NC}"
        ((tests_passed++))
    else
        echo -e "${RED}âŒ ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ›¸ãè¾¼ã¿ã§ãã¾ã›ã‚“${NC}"
    fi
    
    # é€šçŸ¥ãƒ†ã‚¹ãƒˆ
    echo -e "${CYAN}ğŸ”” é€šçŸ¥ãƒ†ã‚¹ãƒˆ:${NC}"
    ((tests_total++))
    if [[ "$OSTYPE" == "darwin"* ]] || command -v notify-send &> /dev/null; then
        echo -e "${GREEN}âœ… é€šçŸ¥æ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™${NC}"
        send_notification "Media-to-Media" "ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã™" "Ping"
        ((tests_passed++))
    else
        echo -e "${YELLOW}âš ï¸  é€šçŸ¥æ©Ÿèƒ½ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“${NC}"
    fi
    
    echo
    echo -e "${CYAN}ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ: ${tests_passed}/${tests_total} é€šé${NC}"
    
    if [[ $tests_passed -eq $tests_total ]]; then
        echo -e "${GREEN}ğŸ‰ ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆã«åˆæ ¼ã—ã¾ã—ãŸï¼${NC}"
    else
        echo -e "${YELLOW}âš ï¸  ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ${NC}"
    fi
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
main() {
    case $1 in
        show|"")
            show_config
            ;;
        stats)
            show_stats
            ;;
        set)
            if [[ -z "$2" || -z "$3" ]]; then
                echo -e "${RED}âŒ ã‚¨ãƒ©ãƒ¼: è¨­å®šé …ç›®ã¨å€¤ã‚’æŒ‡å®šã—ã¦ãã ã•ã„${NC}"
                echo "ä¾‹: media-config set PARALLEL_JOBS 8"
                exit 1
            fi
            update_config "$2" "$3"
            ;;
        reset)
            echo -e "${YELLOW}âš ï¸  è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ (y/N): ${NC}"
            read -r response
            if [[ "$response" =~ ^[Yy]$ ]]; then
                echo "$DEFAULT_CONFIG" > "$CONFIG_FILE"
                echo -e "${GREEN}âœ… è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ${NC}"
                log_info "è¨­å®šãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ"
            else
                echo -e "${BLUE}ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ${NC}"
            fi
            ;;
        logs)
            show_logs "${2:-50}"
            ;;
        cleanup)
            cleanup_logs
            ;;
        update)
            check_updates
            ;;
        test)
            run_tests
            ;;
        -h|--help)
            usage
            ;;
        *)
            echo -e "${RED}âŒ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: $1${NC}"
            usage
            exit 1
            ;;
    esac
}

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main "$@" 